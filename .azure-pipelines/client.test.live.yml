trigger:
  - master

variables:
  PythonVersion27: '2.7'
  PythonVersion35: '3.5'
  PythonVersion36: '3.6'
  PythonVersion37: '3.7'
  PythonVersion38: '3.8.0a2'

jobs:
  - job: 'Windows'

    pool:
      vmImage: 'vs2017-win2016'
    
    timeoutInMinutes: 120

    strategy:
      maxParallel: 1
      matrix:
        x64 Python 2.7:
          PythonArchitecture: 'x64'
          PythonVersion: '$(PythonVersion27)'
        x64 Python 3.5:
          PythonArchitecture: 'x64'
          PythonVersion: '$(PythonVersion35)'
        x64 Python 3.6:
          PythonArchitecture: 'x64'
          PythonVersion: '$(PythonVersion36)'
        x64 Python 3.7:
          PythonArchitecture: 'x64'
          PythonVersion: '$(PythonVersion37)'
        x64 Python 3.8:
          PythonArchitecture: 'x64'
          PythonVersion: '$(PythonVersion38)'

    steps:
      - task: UsePythonVersion@0
        displayName: 'Use Python Version'
        condition: ne(variables['PythonVersion'], variables['PythonVersion38'])
        inputs:
          architecture: '$(PythonArchitecture)'
          versionSpec: '$(PythonVersion)'

      - powershell: |
          choco install python3 --pre --$(PythonArchitecture) --yes --no-progress --params "/InstallDir:C:\PythonPre"
          Write-Host "##vso[task.prependpath]C:\PythonPre\Scripts"
          Write-Host "##vso[task.prependpath]C:\PythonPre"
        displayName: 'Install Python Version'
        condition: eq(variables['PythonVersion'], variables['PythonVersion38'])

      - powershell: |
          python --version
          Invoke-WebRequest -UseBasicParsing -Uri https://bootstrap.pypa.io/get-pip.py | Select-Object -ExpandProperty Content | python
          python -m pip install -r dev_requirements.txt
        displayName: 'Install dependencies'

      - script: python setup.py bdist_wheel
        displayName: 'Build uAMQP Wheel'

      - script: dir dist
        displayName: 'Check output'

      - powershell: |
          $whlfile = Get-ChildItem -Filter *.whl dist | Select-Object -First 1 -ExpandProperty Name
          python -m pip install --ignore-installed ./dist/$whlfile
          pytest tests --doctest-modules --junitxml=junit/test-results-c.xml
          pytest samples --doctest-modules --junitxml=junit/test-results-live.xml
        displayName: 'Run tests'
        env:
          EVENT_HUB_HOSTNAME: $(python-eh-livetest-event-hub-hostname)
          EVENT_HUB_NAME: $(python-eh-livetest-event-hub-name)
          EVENT_HUB_SAS_POLICY: $(python-eh-livetest-event-hub-sas-policy)
          EVENT_HUB_SAS_KEY: $(python-eh-livetest-event-hub-sas-key)
          IOTHUB_HOSTNAME: $(python-iothub-livetest-host-name)
          IOTHUB_HUB_NAME: $(python-iothub-livetest-hub-name)
          IOTHUB_DEVICE: $(python-eh-livetest-event-hub-iothub-device)
          IOTHUB_ENDPOINT: $(python-iothub-livetest-endpoint)
          IOTHUB_SAS_POLICY: $(python-iothub-livetest-sas-policy)
          IOTHUB_SAS_KEY: $(python-iothub-livetest-sas-key)
      - task: PublishTestResults@2
        displayName: 'Publish test results'
        condition: succeededOrFailed()
        inputs:
          testResultsFiles: '**/test-results-*.xml'
          testResultsFormat: 'JUnit'
          testRunTitle: 'Windows $(PythonArchitecture) Python $(PythonVersion)'

  - job: 'MacOS'

    dependsOn: 'Windows'

    timeoutInMinutes: 120

    pool:
      vmImage: 'macOS-10.13'

    strategy:
      maxParallel: 1
      matrix:
        Python 2.7:
          MacOSXDeploymentTarget: '10.6'
          PythonBin: 'python2'
          PythonVersion: '$(PythonVersion27)'
        Python 3.5:
          MacOSXDeploymentTarget: '10.6'
          PythonBin: 'python3'
          PythonVersion: '$(PythonVersion35)'
        Python 3.6:
          MacOSXDeploymentTarget: '10.6'
          PythonBin: 'python3'
          PythonVersion: '$(PythonVersion36)'
        Python 3.7:
          MacOSXDeploymentTarget: '10.6'
          PythonBin: 'python3'
          PythonVersion: '$(PythonVersion37)'

    variables:
      PythonVersion27: '2.7.15'
      PythonVersion35: '3.5.4'
      PythonVersion36: '3.6.5'
      PythonVersion37: '3.7.0'

    steps:

      - script: source ./install_python_osx.sh
        displayName: 'Install Official Python'

      - script: |
          $(PythonBin) --version
          curl -sS https://bootstrap.pypa.io/get-pip.py | $(PythonBin) - --user
          $(PythonBin) -m pip install --user -r dev_requirements.txt
          echo "##vso[task.prependpath]/Users/vsts/Library/Python/`ls /Users/vsts/Library/Python | head -n1`/bin"
        displayName: 'Install dependencies'

      - script: $(PythonBin) setup.py bdist_wheel
        displayName: 'Build uAMQP Wheel'

      - script: ls ./dist
        displayName: 'Check output'

      - script: |
          $(PythonBin) -m pip install --user --ignore-installed ./dist/*.whl
          pytest tests --doctest-modules --junitxml=junit/test-results-c.xml
          pytest samples --doctest-modules --junitxml=junit/test-results-live.xml
        displayName: 'Run tests'
        env:
          EVENT_HUB_HOSTNAME: $(python-eh-livetest-event-hub-hostname)
          EVENT_HUB_NAME: $(python-eh-livetest-event-hub-name)
          EVENT_HUB_SAS_POLICY: $(python-eh-livetest-event-hub-sas-policy)
          EVENT_HUB_SAS_KEY: $(python-eh-livetest-event-hub-sas-key)
          IOTHUB_HOSTNAME: $(python-iothub-livetest-host-name)
          IOTHUB_HUB_NAME: $(python-iothub-livetest-hub-name)
          IOTHUB_DEVICE: $(python-eh-livetest-event-hub-iothub-device)
          IOTHUB_ENDPOINT: $(python-iothub-livetest-endpoint)
          IOTHUB_SAS_POLICY: $(python-iothub-livetest-sas-policy)
          IOTHUB_SAS_KEY: $(python-iothub-livetest-sas-key)

      - task: PublishTestResults@2
        displayName: 'Publish test results'
        condition: succeededOrFailed()
        inputs:
          testResultsFiles: '**/test-results-*.xml'
          testResultsFormat: 'JUnit'
          testRunTitle: 'MacOS Python $(PythonVersion)'


  - job: 'Linux'
    
    timeoutInMinutes: 120

    dependsOn: 'MacOS'

    pool:
      vmImage: 'ubuntu-16.04'

    strategy:
      maxParallel: 1
      matrix:
        Python 2.7:
          PythonVersion: '$(PythonVersion27)'
        Python 3.5:
          PythonVersion: '$(PythonVersion35)'
        Python 3.6:
          PythonVersion: '$(PythonVersion36)'
        Python 3.7:
          PythonVersion: '$(PythonVersion37)'
        Python 3.8:
          PythonVersion: '$(PythonVersion38)'

    steps:
      - task: UsePythonVersion@0
        displayName: 'Use Python Version'
        condition: ne(variables['PythonVersion'], variables['PythonVersion38'])
        inputs:
          versionSpec: '$(PythonVersion)'

      - script: |
          export DEBIAN_FRONTEND=noninteractive
          sudo add-apt-repository -y ppa:deadsnakes/ppa
          sudo apt-get update
          sudo apt-get -q -y install python3.8 python3.8-distutils python3.8-venv python3.8-dev
          sudo update-alternatives --install /usr/bin/python python /usr/bin/python3.8 1
        displayName: 'Install Python Version'
        condition: eq(variables['PythonVersion'], variables['PythonVersion38'])

      - script: |
          python --version
          curl -sS https://bootstrap.pypa.io/get-pip.py | python - --user
          python -m pip install --user -r dev_requirements.txt
          echo "##vso[task.prependpath]/home/vsts/.local/bin"
        displayName: 'Install dependencies'

      - script: python setup.py bdist_wheel
        displayName: 'Build uAMQP Wheel'

      - script: ls ./dist
        displayName: 'Check output'

      - script: |
          python -m pip install --user --ignore-installed ./dist/*.whl
          pytest tests --doctest-modules --junitxml=junit/test-results-c.xml
          pytest samples --doctest-modules --junitxml=junit/test-results-live.xml
        displayName: 'Run tests'
        env:
          EVENT_HUB_HOSTNAME: $(python-eh-livetest-event-hub-hostname)
          EVENT_HUB_NAME: $(python-eh-livetest-event-hub-name)
          EVENT_HUB_SAS_POLICY: $(python-eh-livetest-event-hub-sas-policy)
          EVENT_HUB_SAS_KEY: $(python-eh-livetest-event-hub-sas-key)
          IOTHUB_HOSTNAME: $(python-iothub-livetest-host-name)
          IOTHUB_HUB_NAME: $(python-iothub-livetest-hub-name)
          IOTHUB_DEVICE: $(python-eh-livetest-event-hub-iothub-device)
          IOTHUB_ENDPOINT: $(python-iothub-livetest-endpoint)
          IOTHUB_SAS_POLICY: $(python-iothub-livetest-sas-policy)
          IOTHUB_SAS_KEY: $(python-iothub-livetest-sas-key)
          
      - task: PublishTestResults@2
        displayName: 'Publish test results'
        condition: succeededOrFailed()
        inputs:
          testResultsFiles: '**/test-results-*.xml'
          testResultsFormat: 'JUnit'
          testRunTitle: 'Linux Python $(PythonVersion)'
